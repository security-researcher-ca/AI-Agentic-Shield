name: "Terminal Safety"
description: "Block destructive commands, privilege escalation, and resource exhaustion attacks"
version: "1.0.0"
author: "AgentShield Security Research"

defaults:
  protected_paths: []

rules:
  # === BLOCK: Filesystem destruction ===
  - id: "ts-block-rm-root"
    taxonomy: "destructive-ops/fs-destruction/recursive-root-delete"
    match:
      command_regex: "^(sudo\\s+)?rm\\s+.*-[a-zA-Z]*r[a-zA-Z]*f[a-zA-Z]*\\s+/($|\\s)"
    decision: "BLOCK"
    reason: "Destructive recursive remove at filesystem root."

  - id: "ts-block-rm-force-recursive"
    taxonomy: "destructive-ops/fs-destruction/system-directory-delete"
    match:
      command_regex: "^(sudo\\s+)?rm\\s+.*-[a-zA-Z]*r[a-zA-Z]*f[a-zA-Z]*\\s+(/etc|/usr|/var|/boot|/sys|/proc)($|/|\\s)"
    decision: "BLOCK"
    reason: "Recursive force-remove on critical system directory."

  - id: "ts-block-mkfs"
    taxonomy: "destructive-ops/disk-ops/filesystem-format"
    match:
      command_regex: "^(sudo\\s+)?mkfs"
    decision: "BLOCK"
    reason: "Filesystem creation can destroy disk data."

  - id: "ts-block-dd-zero"
    taxonomy: "destructive-ops/disk-ops/disk-overwrite"
    match:
      command_regex: "^(sudo\\s+)?dd\\s+.*if=/dev/(zero|urandom|random)"
    decision: "BLOCK"
    reason: "dd from /dev/zero or /dev/urandom can overwrite disks."

  # === BLOCK: Fork bomb and resource exhaustion ===
  - id: "ts-block-fork-bomb"
    taxonomy: "destructive-ops/resource-exhaustion/fork-bomb"
    match:
      command_regex: ":\\(\\)\\{.*:\\|:.*\\}|\\bfork\\b.*\\bwhile\\b.*(\\btrue\\b|\\b1\\b)"
    decision: "BLOCK"
    reason: "Fork bomb detected — can crash the system."

  # === BLOCK: Permission weakening ===
  - id: "ts-block-chmod-777"
    taxonomy: "destructive-ops/permission-weakening/chmod-world-writable"
    match:
      command_regex: "^(sudo\\s+)?chmod\\s+(-R\\s+)?777\\s+/"
    decision: "BLOCK"
    reason: "chmod 777 on root paths removes all file protections."

  - id: "ts-block-chmod-recursive-sensitive"
    taxonomy: "destructive-ops/permission-weakening/chmod-world-writable"
    match:
      command_regex: "^(sudo\\s+)?chmod\\s+-R\\s+.*(/etc|/usr|/var|/home)"
    decision: "BLOCK"
    reason: "Recursive permission change on sensitive system directory."

  # === BLOCK: Pipe-to-shell ===
  - id: "ts-block-pipe-to-shell"
    taxonomy: "unauthorized-execution/remote-code-exec/pipe-to-shell"
    match:
      command_regex: "^(curl|wget).*\\|\\s*(sh|bash|zsh|dash|ksh|fish)"
    decision: "BLOCK"
    reason: "Pipe-to-shell executes unreviewed remote code."

  # === BLOCK: Reverse shell indicators ===
  - id: "ts-block-netcat"
    taxonomy: "data-exfiltration/network-egress/reverse-shell"
    match:
      command_regex: "^(nc|ncat|netcat|socat)\\s"
    decision: "BLOCK"
    reason: "Netcat/socat can open reverse shells."

  - id: "ts-block-bash-dev-tcp"
    taxonomy: "data-exfiltration/network-egress/reverse-shell"
    match:
      command_regex: "/dev/tcp/"
    decision: "BLOCK"
    reason: "Bash /dev/tcp is commonly used for reverse shells."

  # === BLOCK: System shutdown/reboot ===
  - id: "ts-block-shutdown"
    match:
      command_prefix: ["shutdown", "reboot", "halt", "poweroff", "init 0", "init 6"]
    decision: "BLOCK"
    reason: "System shutdown/reboot must be done manually."

  # === AUDIT: Privilege escalation tracking ===
  - id: "ts-audit-sudo"
    match:
      command_prefix: ["sudo "]
    decision: "AUDIT"
    reason: "Sudo command flagged for privilege escalation review."

  - id: "ts-audit-chown"
    match:
      command_prefix: ["chown ", "chgrp "]
    decision: "AUDIT"
    reason: "Ownership change flagged for review."

  - id: "ts-audit-crontab"
    match:
      command_prefix: ["crontab "]
    decision: "AUDIT"
    reason: "Crontab modification flagged for persistence review."

  - id: "ts-audit-systemctl"
    match:
      command_prefix: ["systemctl ", "launchctl "]
    decision: "AUDIT"
    reason: "Service management flagged for review."

  # === ALLOW: Common safe commands ===
  - id: "ts-allow-readonly"
    match:
      command_prefix:
        - "ls"
        - "pwd"
        - "whoami"
        - "id"
        - "uname"
        - "date"
        - "uptime"
        - "df"
        - "du"
        - "free"
        - "top -l"
        - "ps "
        - "which "
        - "type "
        - "file "
        - "head "
        - "tail "
        - "wc "
        - "sort "
        - "uniq "
        - "grep "
        - "find "
        - "echo "
        - "printf "
        - "cat "
        - "man "
        - "git log"
        - "git branch"
        - "git show"
        - "git remote"
        - "git tag"
        - "git stash list"
    decision: "ALLOW"
    reason: "Read-only or informational command."

  # === STRUCTURAL RULES ===
  # These use the parsed shell AST instead of regex.
  # They handle flag reordering, long-form flags, and sudo automatically.

  - id: "ts-struct-block-rm-system"
    taxonomy: "destructive-ops/fs-destruction/system-directory-delete"
    match:
      structural:
        executable: "rm"
        flags_all: ["r", "f"]
        args_any: ["/", "/etc/**", "/usr/**", "/var/**", "/boot/**", "/sys/**"]
    decision: "BLOCK"
    confidence: 0.95
    reason: "Structural: recursive force-delete on system directory (handles flag reordering and sudo)."

  - id: "ts-struct-block-chmod-world-writable"
    taxonomy: "destructive-ops/permission-weakening/chmod-world-writable"
    match:
      structural:
        executable: "chmod"
        args_any: ["/etc/**", "/usr/**", "/var/**"]
    decision: "AUDIT"
    confidence: 0.80
    reason: "Structural: chmod on system directory flagged for review."

  - id: "ts-struct-block-pipe-to-shell"
    taxonomy: "unauthorized-execution/remote-code-exec/pipe-to-shell"
    match:
      structural:
        pipe_from: ["curl", "wget", "fetch", "aria2c"]
        pipe_to: ["sh", "bash", "zsh", "dash", "python", "python3", "node", "ruby", "perl"]
    decision: "BLOCK"
    confidence: 0.95
    reason: "Structural: download piped to interpreter. Download and inspect first."

  - id: "ts-struct-block-npm-registry"
    taxonomy: "supply-chain/dependency-confusion/non-standard-registry"
    match:
      structural:
        executable: ["npm", "yarn", "pnpm"]
        subcommand: "install"
        flags_any: ["registry"]
    decision: "BLOCK"
    confidence: 0.90
    reason: "Structural: package install with custom registry override is a supply chain risk."

  # === SEMANTIC RULES ===
  # These match against intents classified by the built-in semantic analyzer.

  - id: "ts-sem-block-disk-destroy"
    taxonomy: "destructive-ops/disk-ops/disk-overwrite"
    match:
      semantic:
        intent: "disk-destroy"
    decision: "BLOCK"
    confidence: 0.95
    reason: "Semantic: any command classified as disk-destroy intent is blocked."

  - id: "ts-sem-block-high-risk"
    match:
      semantic:
        risk_min: "critical"
    decision: "BLOCK"
    confidence: 0.90
    reason: "Semantic: any command with critical risk intent is blocked."

  - id: "ts-sem-allow-dns-safe"
    taxonomy: "data-exfiltration/network-egress/dns-tunneling"
    match:
      semantic:
        intent: "dns-query-safe"
    decision: "ALLOW"
    confidence: 0.90
    reason: "Semantic: safe DNS queries (DMARC/SPF/DKIM) are allowed."

  # === STATEFUL RULES ===
  # These match multi-step attack chains within compound commands.

  - id: "ts-sf-block-download-execute"
    taxonomy: "unauthorized-execution/remote-code-exec/pipe-to-shell"
    match:
      stateful:
        chain:
          - executable_any: ["curl", "wget", "aria2c", "fetch"]
            flags_any: ["o", "O", "output"]
          - executable_any: ["bash", "sh", "zsh", "chmod", "python", "python3", "node"]
    decision: "BLOCK"
    confidence: 0.90
    reason: "Stateful: download-then-execute chain detected."

  - id: "ts-sf-block-recon-then-exfil"
    taxonomy: "data-exfiltration/network-egress/reverse-shell"
    match:
      stateful:
        chain:
          - executable_any: ["find", "locate", "ls"]
          - executable_any: ["tar", "zip", "gzip"]
          - executable_any: ["curl", "wget", "nc", "scp"]
    decision: "BLOCK"
    confidence: 0.85
    reason: "Stateful: reconnaissance → archive → exfiltrate chain detected."
