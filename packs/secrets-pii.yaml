name: "Secrets & PII Protection"
description: "Prevent credential exfiltration, accidental secret exposure, and PII leakage"
version: "1.0.0"
author: "AgentShield Security Research"

defaults:
  protected_paths:
    - "~/.ssh/**"
    - "~/.aws/**"
    - "~/.gnupg/**"
    - "~/.config/gcloud/**"
    - "~/.kube/**"
    - "~/.docker/config.json"
    - "~/.npmrc"
    - "~/.pypirc"
    - "~/.netrc"
    - "~/.git-credentials"
    - "~/.config/gh/**"
    - "~/.vault-token"
    - "~/.terraform.d/**"

rules:
  # === BLOCK: Direct credential file access ===
  - id: "sec-block-ssh-private"
    taxonomy: "credential-exposure/private-key-access/ssh-private-key-read"
    match:
      command_regex: "\\.(ssh|gnupg)/(id_[^.\\s\"']+([\\s\"']|$)|private|secret)"
    decision: "BLOCK"
    reason: "Direct access to private key files is blocked."

  - id: "sec-block-etc-shadow"
    taxonomy: "credential-exposure/password-db-access/system-shadow-read"
    match:
      command_regex: "(/etc/shadow|/etc/master\\.passwd)"
    decision: "BLOCK"
    reason: "Access to system password database is blocked."

  - id: "sec-block-keychain"
    taxonomy: "credential-exposure/password-db-access/keychain-extraction"
    match:
      command_regex: "(security\\s+find-(generic|internet)-password|security\\s+dump-keychain)"
    decision: "BLOCK"
    reason: "macOS Keychain extraction is blocked."

  # === BLOCK: Encoded exfiltration attempts ===
  - id: "sec-block-base64-sensitive"
    taxonomy: "data-exfiltration/encoded-exfil/base64-credential-encode"
    match:
      command_regex: "base64.*\\.(ssh|aws|gnupg|kube|docker)"
    decision: "BLOCK"
    reason: "Base64 encoding of credential files is a common exfiltration technique."

  - id: "sec-block-xxd-sensitive"
    taxonomy: "data-exfiltration/encoded-exfil/hex-dump-sensitive"
    match:
      command_regex: "(xxd|od|hexdump).*\\.(ssh|aws|gnupg)"
    decision: "BLOCK"
    reason: "Hex dumping credential files is a potential exfiltration technique."

  # === BLOCK: Credential harvesting ===
  - id: "sec-block-history-grep-password"
    taxonomy: "credential-exposure/history-mining/history-credential-grep"
    match:
      command_regex: "(history|cat.*_history).*grep.*(password|secret|token|key|api)"
    decision: "BLOCK"
    reason: "Searching shell history for credentials is suspicious."

  # === AUDIT: Environment variable exposure ===
  - id: "sec-audit-env-dump"
    taxonomy: "credential-exposure/secret-env-exposure/env-dump"
    match:
      command_prefix: ["env", "printenv", "set"]
    decision: "AUDIT"
    reason: "Environment dump may expose secrets (API keys, tokens, passwords)."

  - id: "sec-audit-env-grep-secret"
    taxonomy: "credential-exposure/secret-env-exposure/env-dump"
    match:
      command_regex: "(env|printenv|echo\\s+\\$).*(_KEY|_SECRET|_TOKEN|_PASSWORD|_CREDENTIAL|API_KEY)"
    decision: "AUDIT"
    reason: "Targeted access to secret environment variables flagged for review."

  # === AUDIT: Credential file reads ===
  - id: "sec-audit-dotenv"
    match:
      command_regex: "(cat|less|more|head|tail|bat)\\s+\\.env"
    decision: "AUDIT"
    reason: ".env files often contain secrets. Flagged for review."

  - id: "sec-audit-config-files"
    match:
      command_regex: "(cat|less|more|head|tail|bat)\\s+.*(config\\.json|credentials|settings\\.json|secrets\\.)"
    decision: "AUDIT"
    reason: "Configuration file access flagged — may contain secrets."

  # === AUDIT: Clipboard operations with sensitive content ===
  - id: "sec-audit-clipboard"
    match:
      command_prefix: ["pbcopy", "pbpaste", "xclip", "xsel"]
    decision: "AUDIT"
    reason: "Clipboard operations flagged — may leak secrets."

  # === AUDIT: Git credential access ===
  - id: "sec-audit-git-credential"
    match:
      command_prefix: ["git credential"]
    decision: "AUDIT"
    reason: "Git credential access flagged for review."

  # === DATAFLOW RULES ===
  # These track source→sink data flows through pipes and redirects.

  - id: "sec-df-block-cred-to-network"
    taxonomy: "credential-exposure/private-key-access/ssh-private-key-read"
    match:
      dataflow:
        source:
          type: "credential"
        sink:
          type: "network"
    decision: "BLOCK"
    confidence: 0.90
    reason: "Dataflow: credential data piped/redirected to network command (exfiltration)."

  - id: "sec-df-block-cred-encoded-exfil"
    taxonomy: "data-exfiltration/network-egress/dns-tunneling"
    match:
      dataflow:
        source:
          type: "credential"
          paths: ["~/.ssh/**", "~/.aws/**", "~/.gnupg/**"]
        sink:
          commands: ["curl", "wget", "nc", "ncat"]
        via: ["base64", "gzip", "xxd"]
    decision: "BLOCK"
    confidence: 0.95
    reason: "Dataflow: credential data encoded then sent to network (staged exfiltration)."
